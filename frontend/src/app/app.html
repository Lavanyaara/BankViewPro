<div class="dashboard-container">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="logo-section">
      <div class="logo-icon">üè¶</div>
      <h2>Credit Review Dashboard</h2>
    </div>

    <div class="flow-selector">
      <label>Select Flow Type:</label>
      <select [(ngModel)]="selectedFlowType" (change)="onFlowTypeChange()" class="flow-select">
        <option value="bank">Bank Flow</option>
        <option value="broker">Broker Flow</option>
      </select>
      <p class="flow-description">
        {{ selectedFlowType === 'bank' ? 'Using SEC EDGAR + FFIEC Call Reports' : 'Using FINRA BrokerCheck + SEC EDGAR' }}
      </p>
    </div>

    <div class="institution-selector">
      <label>Select Financial Institution:</label>
      @if (filteredInstitutions().length > 0) {
        <select [(ngModel)]="selectedInstitutionName" (change)="onInstitutionChange()" class="institution-select">
          @for (inst of filteredInstitutions(); track inst.name) {
            <option [value]="inst.name">{{ inst.name }}</option>
          }
        </select>
      } @else {
        <div class="no-institutions-message">
          No {{ flowType() === 'broker' ? 'broker-dealers' : 'banks' }} available
        </div>
      }
    </div>

    @if (scores()) {
      <div class="score-card">
        <h3>Overall Credit Score</h3>
        <div class="score-value" [style.color]="getRatingColor(scores()!.overall)">
          {{ scores()!.overall.toFixed(1) }}/10.0
        </div>
        <div class="rating-badge" [style.background-color]="getRatingColor(scores()!.overall)">
          {{ scores()!.rating }}
        </div>
      </div>
    }
  </aside>

  <!-- Main Content -->
  <main class="main-content">
    <header class="header">
      <h1>Credit Review Dashboard</h1>
      <p class="subtitle">Comprehensive Analytics for US Banks and Broker Dealers</p>
    </header>

    <!-- Tabs -->
    <div class="tabs-container">
      <nav class="tabs">
        <button 
          class="tab" 
          [class.active]="activeTab() === 'overview'"
          (click)="setActiveTab('overview')">
          üìä Overview
        </button>
        <button 
          class="tab" 
          [class.active]="activeTab() === 'capitalization'"
          (click)="setActiveTab('capitalization')">
          üí∞ Capitalization
        </button>
        <button 
          class="tab" 
          [class.active]="activeTab() === 'asset_quality'"
          (click)="setActiveTab('asset_quality')">
          üìà Asset Quality
        </button>
        <button 
          class="tab" 
          [class.active]="activeTab() === 'profitability'"
          (click)="setActiveTab('profitability')">
          üíπ Profitability
        </button>
        <button 
          class="tab" 
          [class.active]="activeTab() === 'liquidity'"
          (click)="setActiveTab('liquidity')">
          üíß Liquidity
        </button>
      </nav>
    </div>

    <!-- Tab Content -->
    @if (loading()) {
      <div class="loading">Loading...</div>
    } @else {
      <div class="tab-content">
        <!-- Overview Tab -->
        @if (activeTab() === 'overview' && institutionDetail() && scores()) {
          <div class="tab-panel">
            <h2>üìä Executive Overview</h2>
            
            <div class="metrics-grid">
              <div class="metric-card">
                <div class="metric-label">Capitalization Score</div>
                <div class="metric-value" [style.color]="getRatingColor(scores()!.capitalization)">
                  {{ scores()!.capitalization.toFixed(1) }}/10
                </div>
              </div>
              <div class="metric-card">
                <div class="metric-label">Asset Quality Score</div>
                <div class="metric-value" [style.color]="getRatingColor(scores()!.asset_quality)">
                  {{ scores()!.asset_quality.toFixed(1) }}/10
                </div>
              </div>
              <div class="metric-card">
                <div class="metric-label">Profitability Score</div>
                <div class="metric-value" [style.color]="getRatingColor(scores()!.profitability)">
                  {{ scores()!.profitability.toFixed(1) }}/10
                </div>
              </div>
              <div class="metric-card">
                <div class="metric-label">Liquidity Score</div>
                <div class="metric-value" [style.color]="getRatingColor(scores()!.liquidity)">
                  {{ scores()!.liquidity.toFixed(1) }}/10
                </div>
              </div>
            </div>

            @if (commentary()['overview']) {
              <div class="commentary-section">
                <h3>Executive Summary</h3>
                <p>{{ commentary()['overview'] }}</p>
              </div>
            }

            <!-- Chatbot Interface -->
            <div class="chat-section">
              <h3>üí¨ Ask About This Institution</h3>
              <div class="chat-container">
                <div class="chat-messages">
                  @if (chatMessages().length === 0) {
                    <div class="chat-welcome">
                      <p>üëã Welcome! I'm your financial analyst assistant.</p>
                      <p>Ask me anything about {{ selectedInstitution() }}'s financial metrics, credit scores, or overall performance.</p>
                    </div>
                  }
                  @for (msg of chatMessages(); track $index) {
                    <div class="chat-message" [class.user-message]="msg.role === 'user'" [class.assistant-message]="msg.role === 'assistant'">
                      <div class="message-role">{{ msg.role === 'user' ? 'You' : 'Assistant' }}</div>
                      <div class="message-content">{{ msg.content }}</div>
                    </div>
                  }
                  @if (chatLoading()) {
                    <div class="chat-message assistant-message">
                      <div class="message-role">Assistant</div>
                      <div class="message-content typing">Analyzing...</div>
                    </div>
                  }
                </div>
                <div class="chat-input-container">
                  <input 
                    type="text" 
                    [(ngModel)]="chatInput" 
                    (keyup.enter)="sendChatMessage()"
                    placeholder="Ask a question about the institution's financials..."
                    class="chat-input"
                    [disabled]="chatLoading()"
                  />
                  <button 
                    (click)="sendChatMessage()" 
                    class="chat-send-btn"
                    [disabled]="chatLoading() || !chatInput.trim()"
                  >
                    Send
                  </button>
                </div>
              </div>
            </div>
          </div>
        }

        <!-- Capitalization Tab -->
        @if (activeTab() === 'capitalization' && getLatestData()) {
          <div class="tab-panel">
            <h2>üí∞ Capitalization Analysis</h2>
            
            <div class="metrics-grid">
              <div class="metric-card">
                <div class="metric-label">Capital Adequacy Ratio</div>
                <div class="metric-value">{{ getLatestData()!.capital_adequacy_ratio.toFixed(1) }}%</div>
                @if (getPreviousData()) {
                  <div class="metric-change">{{ calculateChange(getLatestData()!.capital_adequacy_ratio, getPreviousData()!.capital_adequacy_ratio) }}%</div>
                }
              </div>
              <div class="metric-card">
                <div class="metric-label">Tier 1 Ratio</div>
                <div class="metric-value">{{ getLatestData()!.tier1_ratio.toFixed(1) }}%</div>
                @if (getPreviousData()) {
                  <div class="metric-change">{{ calculateChange(getLatestData()!.tier1_ratio, getPreviousData()!.tier1_ratio) }}%</div>
                }
              </div>
              <div class="metric-card">
                <div class="metric-label">Leverage Ratio</div>
                <div class="metric-value">{{ getLatestData()!.leverage_ratio.toFixed(1) }}%</div>
                @if (getPreviousData()) {
                  <div class="metric-change">{{ calculateChange(getLatestData()!.leverage_ratio, getPreviousData()!.leverage_ratio) }}%</div>
                }
              </div>
            </div>

            @if (commentary()['capitalization']) {
              <div class="commentary-section">
                <h3>Capital Assessment</h3>
                <p>{{ commentary()['capitalization'] }}</p>
              </div>
            }
          </div>
        }

        <!-- Asset Quality Tab -->
        @if (activeTab() === 'asset_quality' && getLatestData()) {
          <div class="tab-panel">
            <h2>üìà Asset Quality Analysis</h2>
            
            <div class="metrics-grid">
              <div class="metric-card">
                <div class="metric-label">NPL Ratio</div>
                <div class="metric-value">{{ getLatestData()!.npl_ratio.toFixed(2) }}%</div>
                @if (getPreviousData()) {
                  <div class="metric-change">{{ calculateChange(getLatestData()!.npl_ratio, getPreviousData()!.npl_ratio) }}%</div>
                }
              </div>
              <div class="metric-card">
                <div class="metric-label">Loan Loss Provisions</div>
                <div class="metric-value">{{ getLatestData()!.loan_loss_provisions.toFixed(2) }}%</div>
                @if (getPreviousData()) {
                  <div class="metric-change">{{ calculateChange(getLatestData()!.loan_loss_provisions, getPreviousData()!.loan_loss_provisions) }}%</div>
                }
              </div>
              <div class="metric-card">
                <div class="metric-label">Coverage Ratio</div>
                <div class="metric-value">{{ getLatestData()!.coverage_ratio.toFixed(0) }}%</div>
                @if (getPreviousData()) {
                  <div class="metric-change">{{ calculateChange(getLatestData()!.coverage_ratio, getPreviousData()!.coverage_ratio) }}%</div>
                }
              </div>
            </div>

            @if (commentary()['asset_quality']) {
              <div class="commentary-section">
                <h3>Asset Quality Assessment</h3>
                <p>{{ commentary()['asset_quality'] }}</p>
              </div>
            }
          </div>
        }

        <!-- Profitability Tab -->
        @if (activeTab() === 'profitability' && getLatestData()) {
          <div class="tab-panel">
            <h2>üíπ Profitability Analysis</h2>
            
            <div class="metrics-grid">
              <div class="metric-card">
                <div class="metric-label">Return on Assets</div>
                <div class="metric-value">{{ getLatestData()!.return_on_assets.toFixed(2) }}%</div>
                @if (getPreviousData()) {
                  <div class="metric-change">{{ calculateChange(getLatestData()!.return_on_assets, getPreviousData()!.return_on_assets) }}%</div>
                }
              </div>
              <div class="metric-card">
                <div class="metric-label">Return on Equity</div>
                <div class="metric-value">{{ getLatestData()!.return_on_equity.toFixed(1) }}%</div>
                @if (getPreviousData()) {
                  <div class="metric-change">{{ calculateChange(getLatestData()!.return_on_equity, getPreviousData()!.return_on_equity) }}%</div>
                }
              </div>
              <div class="metric-card">
                <div class="metric-label">Net Interest Margin</div>
                <div class="metric-value">{{ getLatestData()!.net_interest_margin.toFixed(2) }}%</div>
                @if (getPreviousData()) {
                  <div class="metric-change">{{ calculateChange(getLatestData()!.net_interest_margin, getPreviousData()!.net_interest_margin) }}%</div>
                }
              </div>
              <div class="metric-card">
                <div class="metric-label">Cost-to-Income Ratio</div>
                <div class="metric-value">{{ getLatestData()!.cost_to_income_ratio.toFixed(1) }}%</div>
                @if (getPreviousData()) {
                  <div class="metric-change">{{ calculateChange(getLatestData()!.cost_to_income_ratio, getPreviousData()!.cost_to_income_ratio) }}%</div>
                }
              </div>
            </div>

            @if (commentary()['profitability']) {
              <div class="commentary-section">
                <h3>Profitability Assessment</h3>
                <p>{{ commentary()['profitability'] }}</p>
              </div>
            }
          </div>
        }

        <!-- Liquidity Tab -->
        @if (activeTab() === 'liquidity' && getLatestData()) {
          <div class="tab-panel">
            <h2>üíß Liquidity Analysis</h2>
            
            <div class="metrics-grid">
              <div class="metric-card">
                <div class="metric-label">Liquidity Coverage Ratio</div>
                <div class="metric-value">{{ getLatestData()!.liquidity_coverage_ratio.toFixed(1) }}%</div>
                @if (getPreviousData()) {
                  <div class="metric-change">{{ calculateChange(getLatestData()!.liquidity_coverage_ratio, getPreviousData()!.liquidity_coverage_ratio) }}%</div>
                }
              </div>
              <div class="metric-card">
                <div class="metric-label">Net Stable Funding Ratio</div>
                <div class="metric-value">{{ getLatestData()!.net_stable_funding_ratio.toFixed(1) }}%</div>
                @if (getPreviousData()) {
                  <div class="metric-change">{{ calculateChange(getLatestData()!.net_stable_funding_ratio, getPreviousData()!.net_stable_funding_ratio) }}%</div>
                }
              </div>
              <div class="metric-card">
                <div class="metric-label">Loan-to-Deposit Ratio</div>
                <div class="metric-value">{{ getLatestData()!.loan_to_deposit_ratio.toFixed(1) }}%</div>
                @if (getPreviousData()) {
                  <div class="metric-change">{{ calculateChange(getLatestData()!.loan_to_deposit_ratio, getPreviousData()!.loan_to_deposit_ratio) }}%</div>
                }
              </div>
              <div class="metric-card">
                <div class="metric-label">Cash Ratio</div>
                <div class="metric-value">{{ getLatestData()!.cash_ratio.toFixed(1) }}%</div>
                @if (getPreviousData()) {
                  <div class="metric-change">{{ calculateChange(getLatestData()!.cash_ratio, getPreviousData()!.cash_ratio) }}%</div>
                }
              </div>
            </div>

            @if (commentary()['liquidity']) {
              <div class="commentary-section">
                <h3>Liquidity Assessment</h3>
                <p>{{ commentary()['liquidity'] }}</p>
              </div>
            }
          </div>
        }
      </div>
    }
  </main>
</div>
